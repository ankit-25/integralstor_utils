from integralstor_common import command
import re

"""
route functionalilties imlemented here

list routes : route -n
add default route : route add default netmask 255.255.255.0 gw 192.168.1.1
delete default rouote : route del default
edit default route : delete and add again

----

add static route : route add -net 192.168.0.0 netmask 24 gw 192.168.0.6
delete static route : route del -net 192.168.0.0 netmask 24 
edit  static route : delete and add
----
bind a route to a specific interface

add, dev interface name to the above commands.
"""

def add_route(name,gw,netmask='255.255.255.0',interface=None):
    if not name or not gw:
        return False,"Interface name or gateway missing"
    else:
        if name == 'default':
            cmd = 'route add -net 0.0.0.0 netmask '+netmask+' gw '+gw
        else: 
            cmd = 'route add -net '+name+' netmask '+netmask+' gw '+gw
        if interface:
            cmd = cmd + ' dev '+interface[0]
        print cmd
        (ret,rc),err = command.execute_with_rc(cmd)
        if err:
            return False,err
        return (ret,rc),None


def delete_route(name,netmask='255.255.255.0'):
    if not name:
        return False,"Interface name missing"
    else:
        if name == 'default':
            cmd = 'route del -net 0.0.0.0 netmask '+netmask
        else: 
            cmd = 'route del -net '+name+' netmask '+netmask
        (ret,rc),err = command.execute_with_rc(cmd)
        if err:
            return False,err
        return (ret,rc),None

def list_routes():
    route_list = []
    for c in command.get_command_output('route -n')[0][2:]:
        if re.match('0.0.0.0',c):
            # A simple hack to actually remove all the unnecessary white spaces and return the atual content as a list
            route_list.append(" ".join(c.split()).split())
        else:
            pass
    return route_list

def main():
    #print add_route('192.168.0.0','192.168.1.4','255.255.255.0')
    #print add_route('default','192.168.1.5','255.255.255.0')
    print list_routes()
    #print delete_route('192.168.0.0','255.255.255.0')
    #print delete_route('default','255.255.255.0')
    #list_routes()

if __name__ == '__main__':
    main()

# vim: tabstop=8 softtabstop=0 expandtab ai shiftwidth=4 smarttab
