import os
import json


def get_init_type():
    """Determine if we are on an init or a systemd type OS."""
    init_type = None
    try:
        with open('/proc/1/cmdline', 'r') as f:
            line = f.readline()
            if 'init' in line:
                init_type = 'init'
            elif 'systemd' in line:
                init_type = 'systemd'
            else:
                raise Exception('Unknown init type')
    except Exception, e:
        return None, 'Error retrieving init type : %s' % e
    else:
        return init_type, None


def get_platform():
    """Tells us if we are running an integralstor or gridcell based on the file called platform which is generated by the install process."""
    platform = None
    try:
        product_root, err = get_product_root()
        if err:
            raise Exception(err)
        with open('%s/platform' % product_root, 'r') as f:
            pd = json.load(f)
            if pd and 'platform' in pd:
                platform = pd['platform']
        if not platform or (platform not in ['unicell', 'gridcell']):
            raise Exception('Unrecognized platform type')
    except Exception, e:
        return None, "Error retrieving platform type : %s" % str(e)
    else:
        return platform, None


def get_hardware_platform():
    """Tells us if we are running on a known hardware platform for which specific code is available."""
    platform = None
    try:
        product_root, err = get_product_root()
        if err:
            raise Exception(err)
        with open('%s/platform' % product_root, 'r') as f:
            pd = json.load(f)
            if pd and 'platform' in pd:
                platform = pd['hardware_vendor']
    except Exception, e:
        return None, "Error retrieving platform type : %s" % str(e)
    else:
        return platform, None


def use_salt():
    """ Shd we use salt or not? This gives us the answer. Currently, it says no for integralstor and yes for gridcell."""
    use = False
    try:
        platform, err = get_platform()
        if err:
            raise Exception(err)
        if platform and platform == 'gridcell':
            use = True
    except Exception, e:
        return False, "Error checking saltstack usage : %s" % str(e)
    else:
        return use, None


def get_product_root():
    """The install root for family of products. """
    return '/opt/integralstor', None


def get_platform_root():
    """The root directory for integralstor or gridcell. """
    root = None
    try:
        platform, err = get_platform()
        if err:
            raise Exception(err)
        product_root, err = get_product_root()
        if err:
            raise Exception(err)
        if not platform:
            raise Exception('Could not determine platform')
        root = '%s/integralstor_%s' % (product_root, platform)
    except Exception, e:
        return None, "Error retrieving platform root : %s" % str(e)
    else:
        return root, None


def get_version():
    """Read the version file and return the version string."""
    version = "Unspecified"
    try:
        lines = None
        platform_root, err = get_platform_root()
        if err:
            raise Exception(err)
        with open('%s/version' % platform_root, 'r') as f:
            lines = f.readlines()
        if lines:
            version = lines[0].strip()
    except Exception, e:
        return None, "Error retrieving version number : %s" % str(e)
    else:
        return version, None


def get_pki_dir():
    """The directory where SSL certs and keys are stored. """
    dir = None
    try:
        product_root, err = get_product_root()
        if err:
            raise Exception(err)
        dir = '%s/pki' % product_root
    except Exception, e:
        return None, "Error retrieving certificates location : %s" % str(e)
    else:
        return dir, None


def get_defaults_dir():
    """The directory where the install defaults are stored. """
    ret = None
    try:
        root, err = get_platform_root()
        if err:
            raise Exception(err)
        if not root:
            raise Exception('Could not retrieve platform root')
        ret = "%s/defaults" % root
    except Exception, e:
        return None, 'Error getting defaults directory : %s' % str(e)
    else:
        return ret, None


def get_tmp_path():
    """Path to a temp dir for use in the code. """
    ret = None
    try:
        root, err = get_platform_root()
        if err:
            raise Exception(err)
        if not root:
            raise Exception('Could not retrieve platform root')
        ret = "%s/tmp" % root
    except Exception, e:
        return None, 'Error getting tmp directory : %s' % str(e)
    else:
        return ret, None


def get_python_scripts_path():
    """Path to python scripts specific to the platform."""
    ret = None
    try:
        root, err = get_platform_root()
        if err:
            raise Exception(err)
        if not root:
            raise Exception('Could not retrieve platform root')
        ret = "%s/scripts/python" % root
    except Exception, e:
        return None, 'Error getting python scripts directory : %s' % str(e)
    else:
        return ret, None


def get_common_python_scripts_path():
    """Path to python scripts common across platforms."""
    ret = None
    try:
        product_root, err = get_product_root()
        if err:
            raise Exception(err)
        ret = "%s/integralstor_common/scripts/python" % product_root
    except Exception, e:
        return None, 'Error getting python scripts directory : %s' % str(e)
    else:
        return ret, None


def get_shell_scripts_path():
    """Path to shell scripts specific to the platform."""
    ret = None
    try:
        root, err = get_platform_root()
        if err:
            raise Exception(err)
        if not root:
            raise Exception('Could not retrieve platform root')
        ret = "%s/scripts/shell" % root
    except Exception, e:
        return None, 'Error getting shell scripts directory : %s' % str(e)
    else:
        return ret, None


def get_admin_vol_name():
    """ gridcell specific - the gluster volume used to store config info."""
    return "integralstor_admin_vol", None


def get_config_dir():
    """The path to the dir where all integralstor configs and logs are stored."""
    ret = None
    try:
        root, err = get_platform_root()
        if err:
            raise Exception(err)
        if not root:
            raise Exception('Could not retrieve platform root')
        ret = "%s/config" % root
    except Exception, e:
        return None, 'Error getting config directory : %s' % str(e)
    else:
        return ret, None


def get_salt_master_config():
    """ The salt master file """
    return '/etc/salt/master', None


def get_krb5_conf_path():
    """Path to the kerberos config file."""
    return '/etc', None


def get_smb_conf_path():
    """Path to the samba config file."""
    return '/etc/samba', None


def get_system_status_path():
    """The path to the dir where the system status and manifest files are stored."""
    ret = None
    try:
        root, err = get_config_dir()
        if err:
            raise Exception(err)
        if not root:
            raise Exception('Could not retrieve platform root')
        ret = "%s/status" % root
    except Exception, e:
        return None, 'Error getting system status directory : %s' % str(e)
    else:
        return ret, None


def get_log_folder_path():
    """The path to the dir where integralstor specific logs are stored. """
    ret = None
    try:
        root, err = get_config_dir()
        if err:
            raise Exception(err)
        if not root:
            raise Exception('Could not retrieve platform root')
        ret = "%s/logs" % root
    except Exception, e:
        return None, 'Error getting logs directory : %s' % str(e)
    else:
        return ret, None


def get_ntp_conf_path():
    """The path where the ntp.conf is stored."""
    return "/etc", None


def get_db_path():
    """Path where the integralstor database is stored."""
    ret = None
    try:
        root, err = get_config_dir()
        if err:
            raise Exception(err)
        if not root:
            raise Exception('Could not retrieve config root')
        ret = "%s/db/integral_view_config.db" % root
    except Exception, e:
        return None, 'Error getting system database directory : %s' % str(e)
    else:
        return ret, None


def get_batch_files_path():
    """Path to the location where batch process files are generated and stored. Mainly used in gridcell."""
    ret = None
    try:
        root, err = get_config_dir()
        if err:
            raise Exception(err)
        if not root:
            raise Exception('Could not retrieve config root')
        ret = "%s/batch_processes" % root
    except Exception, e:
        return None, 'Error getting system batch processes directory : %s' % str(e)
    else:
        return ret, None


def get_audit_dir():
    """Path to the audit log dir."""
    ret = None
    try:
        root, err = get_log_folder_path()
        if err:
            raise Exception(err)
        if not root:
            raise Exception('Could not retrieve logs root')
        ret = "%s/audit" % root
    except Exception, e:
        return None, 'Error getting system audit logs directory : %s' % str(e)
    else:
        return ret, None


def get_alerts_dir():
    """Path to the alerts log dir."""
    ret = None
    try:
        root, err = get_log_folder_path()
        if err:
            raise Exception(err)
        if not root:
            raise Exception('Could not retrieve config root')
        ret = "%s/alerts" % root
    except Exception, e:
        return None, 'Error getting system alerts log directory : %s' % str(e)
    else:
        return ret, None


def main():
    print get_platform()
    print get_hardware_platform()
    # print get_version()


if __name__ == "__main__":
    main()

# vim: tabstop=8 softtabstop=0 expandtab ai shiftwidth=4 smarttab
