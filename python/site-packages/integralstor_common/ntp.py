import re

import integralstor_common
from integralstor_common import command, common


def get_ntp_servers():

  list = []
  try :
    ntp_conf_path, err = common.get_ntp_conf_path()
    if err:
      raise Exception(err)
    with open("%s/ntp.conf"%ntp_conf_path, "r") as f:
      lines = f.readlines()
      for line in lines:
        r1 = re.match("[\s]*server[\s]*([\S]+)", line)
        if r1:
          r = r1.groups()
          if len(r) > 0:
            s = r[0]
            if s and s != "127.0.0.1":
              list.append(s)
  except Exception, e:
    return None, 'Error getting NTP server list : %s'%str(e)
  else:
    return list, None

def restart_ntp_service():

  try:
    (r, rc), err = command.execute_with_rc("service ntpd stop")
    if err:
      raise Exception(err)
    #print r, rc
    (r, rc), err = command.execute_with_rc("service ntpd start")
    if err:
      raise Exception(err)
    #print r, rc
    if rc != 0:
      str = ""
      l, er = command.get_output_list(r)
      if er:
        raise Exception(er)
      if l:
        str += ",".join(l)
      l, er = command.get_error_list(r)
      if er:
        raise Exception(er)
      if l:
        str += ",".join(l)
      raise Exception("Error restarting NTP services : %s"%str)
  except Exception, e:
    return False, 'Error restarting the NTP service: %s'%str(e)
  else:
    return True, None



